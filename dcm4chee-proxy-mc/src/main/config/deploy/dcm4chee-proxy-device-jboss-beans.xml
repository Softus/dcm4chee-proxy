<?xml version="1.0" encoding="UTF-8"?>
<!-- ***** BEGIN LICENSE BLOCK *****
   - Version: MPL 1.1/GPL 2.0/LGPL 2.1
   -
   - The contents of this file are subject to the Mozilla Public License Version
   - 1.1 (the "License"); you may not use this file except in compliance with
   - the License. You may obtain a copy of the License at
   - http://www.mozilla.org/MPL/
   -
   - Software distributed under the License is distributed on an "AS IS" basis,
   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
   - for the specific language governing rights and limitations under the
   - License.
   -
   - The Original Code is part of dcm4che, an implementation of DICOM(TM) in
   - Java(TM), hosted at https://github.com/gunterze/dcm4che.
   -
   - The Initial Developer of the Original Code is
   - Agfa Healthcare.
   - Portions created by the Initial Developer are Copyright (C) 2011
   - the Initial Developer. All Rights Reserved.
   -
   - Contributor(s):
   - Gunter Zeilinger <gunterze@gmail.com>
   - Michael Backhaus <michael.backhaus@agfa.com>
   -
   - Alternatively, the contents of this file may be used under the terms of
   - either the GNU General Public License Version 2 or later (the "GPL"), or
   - the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
   - in which case the provisions of the GPL or the LGPL are applicable instead
   - of those above. If you wish to allow use of your version of this file only
   - under the terms of either the GPL or the LGPL, and not to allow others to
   - use your version of this file under the terms of the MPL, indicate your
   - decision by deleting the provisions above and replace them with the notice
   - and other provisions required by the GPL or the LGPL. If you do not delete
   - the provisions above, a recipient may use your version of this file under
   - the terms of any one of the MPL, the GPL or the LGPL.
   -
   - ***** END LICENSE BLOCK *****  -->
   
<deployment xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="urn:jboss:bean-deployer bean-deployer_2_0.xsd"
  xmlns="urn:jboss:bean-deployer:2.0">

  <bean name="Executer" class="java.util.concurrent.Executor">
    <constructor factoryClass="java.util.concurrent.Executors"
      factoryMethod="newCachedThreadPool" />
  </bean>

  <bean name="ScheduledExecutorService" class="java.util.concurrent.ScheduledExecutorService">
    <constructor factoryClass="java.util.concurrent.Executors"
      factoryMethod="newSingleThreadScheduledExecutor" />
  </bean>
  
  <!-- LDAP Archive Configuration -->
  <bean name="ArchiveConfiguration" class="org.dcm4chee.archive.conf.ldap.LdapArchiveConfiguration">
    <constructor>
      <parameter>
        <javabean xmlns="urn:jboss:javabean:2.0" class="org.dcm4che.conf.ldap.LdapEnv">
          <property name="url">ldap://localhost:389</property>
          <property name="userDN">cn=admin,dc=nodomain</property>
          <property name="password">admin</property>
        </javabean>
      </parameter>
      <parameter>dc=nodomain</parameter>
    </constructor>
  </bean>

  <!-- Preferences Archive Configuration
  <bean name="ArchiveConfiguration" class="org.dcm4chee.archive.conf.pref.PreferencesArchiveConfiguration">
    <constructor>
      <parameter>
        <javabean xmlns="urn:jboss:javabean:2.0" class="java.util.prefs.Preferences">
          <constructor factoryClass="java.util.prefs.Preferences" factoryMethod="userRoot"/>
        </javabean>
      </parameter> 
    </constructor>
  </bean>
  -->
  
  <!-- The DICOM Device -->
  <bean name="Device" class="org.dcm4chee.proxy.mc.net.ProxyDevice">
    <constructor factoryMethod="findDevice">
      <factory bean="ArchiveConfiguration"/>
      <parameter>DCM4CHEE Proxy</parameter>
    </constructor>
    <property name="executor">
      <inject bean="Executer" />
    </property>
    <property name="scheduledExecutor">
      <inject bean="ScheduledExecutorService" />
    </property>
    <property name="dimseRQHandler">
      <inject bean="DicomServiceRegistry" />
    </property>
    <start method="activate" />
    <stop method="deactivate" />
    <demand>HornetQServer</demand>
  </bean>

  <!-- Proxy Connection -->
  <bean name="ProxyConnection1" class="org.dcm4che.net.Connection">
    <property name="port">11112</property>
  </bean>

  <!-- Proxy DICOM Application Entity -->
  <bean name="ProxyApplicationEntity1" class="org.dcm4chee.proxy.mc.net.ProxyApplicationEntity">
    <constructor>
      <parameter>*</parameter>
    </constructor>
    <property name="associationAcceptor">true</property>
    <property name="associationInitiator">true</property>
    <property name="maxOpsPerformed">0</property>
    <property name="maxOpsInvoked">0</property>
    <property name="spoolDirectory">${jboss.server.data.dir}/proxy/</property>
    <property name="acceptDataOnFailedNegotiation">true</property>
    <property name="forwardDestination">
      <inject bean="ForwardApplicationEntity1" />
    </property>
    <property name="useCallingAETitle">
      <null/>
    </property>
    <property name="attributeCoercionURI">resource:dcm4chee-proxy-nullify-pn.xsl</property>
    <property name="forwardSchedule">
      <inject bean="forwardScheduleApplicationEntity1"/>
    </property>
    <property name="retries">
      <list>
        <javabean xmlns="urn:jboss:javabean:2.0" class="org.dcm4chee.proxy.mc.net.Retry">
          <constructor>
            <property name="AString">.conn</property><!-- retry type -->
            <property name="AInt">60</property><!-- time in seconds -->
            <property name="AInt">5</property><!-- number of retries -->
          </constructor>
        </javabean>
        <javabean xmlns="urn:jboss:javabean:2.0" class="org.dcm4chee.proxy.mc.net.Retry">
          <constructor>
            <property name="AString">.ass</property><!-- retry type -->
            <property name="AInt">60</property><!-- time in seconds -->
            <property name="AInt">5</property><!-- number of retries -->
          </constructor>
        </javabean>
      </list>
    </property>
    <install method="addConnection">
      <parameter>
        <inject bean="ProxyConnection1" />
      </parameter>
    </install>
    <uninstall method="removeConnection">
      <parameter>
        <inject bean="ProxyConnection1" />
      </parameter>
    </uninstall>
    <property name="exclusiveUseDefinedTC">true</property>
    <!-- add all TC -->
    <incallback method="addTransferCapability" />
    <!-- add defined TC 
    <install method="addTransferCapability" >
      <parameter>
        <inject bean="MRStorageSCP" />
      </parameter>
    </install>
    <install method="addTransferCapability" >
      <parameter>
        <inject bean="MRStorageSCU" />
      </parameter>
    </install>
    -->
    <property name="enableAuditLog">true</property>
    <property name="auditDirectory">${jboss.server.data.dir}/auditlog/</property>
  </bean>

  <!-- Forward Connection -->
  <bean name="ForwardConnection1" class="org.dcm4che.net.Connection">
    <property name="hostname">localhost</property>
    <property name="port">11113</property>
    <property name="requestTimeout">1000</property><!-- time in milliseconds -->
    <property name="dimseRSPTimeout">1000</property><!-- time in milliseconds -->
  </bean>

  <!-- Forward DICOM Application Entity -->
  <bean name="ForwardApplicationEntity1" class="org.dcm4che.net.ApplicationEntity">
    <constructor>
      <parameter>*</parameter>
    </constructor>
    <property name="associationAcceptor">true</property>
    <property name="maxOpsPerformed">0</property>
    <property name="maxOpsInvoked">0</property>
    <install method="addConnection">
      <parameter>
        <inject bean="ForwardConnection1" />
      </parameter>
    </install>
    <uninstall method="removeConnection">
      <parameter>
        <inject bean="ForwardConnection1" />
      </parameter>
    </uninstall>
  </bean>
  
  <!-- Schedule for Forward DICOM Application Entity -->
  <bean name="forwardScheduleApplicationEntity1" class="org.dcm4chee.proxy.mc.net.Schedule">
    <property name="days">Mon-Fri</property>
    <property name="hours">8-18</property>
  </bean>
  
  <!-- Schedule -->
  <bean name="Scheduler" class="org.dcm4chee.proxy.mc.net.Scheduler">
    <constructor>
      <parameter>
        <inject bean="Device"></inject>
      </parameter>
      <parameter>
        <inject bean="AuditLog"></inject>
      </parameter>
    </constructor>
    <start method="start" />
    <stop method="stop" />
  </bean>
  
  <!-- Audit Log -->
  <bean name="AuditLog" class="org.dcm4chee.proxy.mc.net.AuditLog">
    <property name="delay">60</property><!-- time in seconds -->
  </bean>
  
</deployment>
