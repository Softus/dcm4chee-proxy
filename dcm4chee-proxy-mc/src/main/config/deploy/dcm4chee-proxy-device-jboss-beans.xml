<?xml version="1.0" encoding="UTF-8"?>
<deployment xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="urn:jboss:bean-deployer bean-deployer_2_0.xsd"
  xmlns="urn:jboss:bean-deployer:2.0">

  <bean name="Executer" class="java.util.concurrent.Executor">
    <constructor factoryClass="java.util.concurrent.Executors"
      factoryMethod="newCachedThreadPool" />
  </bean>

  <bean name="ScheduledExecutorService" class="java.util.concurrent.ScheduledExecutorService">
    <constructor factoryClass="java.util.concurrent.Executors"
      factoryMethod="newSingleThreadScheduledExecutor" />
  </bean>

 
  <!-- The DICOM Device -->
  <bean name="Device" class="org.dcm4che.net.Device">
    <constructor>
      <parameter>dcm4chee-proxy</parameter>
    </constructor>
    <property name="executor">
      <inject bean="Executer" />
    </property>
    <property name="scheduledExecutor">
      <inject bean="ScheduledExecutorService" />
    </property>
    <property name="dimseRQHandler">
      <inject bean="DicomServiceRegistry" />
    </property>
    <demand>HornetQServer</demand>
    <install method="addConnection">
      <parameter>
        <inject bean="ProxyConnection1" />
      </parameter>
    </install>
    <install method="addApplicationEntity">
      <parameter>
        <inject bean="ProxyApplicationEntity1" />
      </parameter>
    </install>
    <install method="setProperty">
      <parameter>scheduler.period</parameter>
      <parameter>
        <javabean xmlns="urn:jboss:javabean:2.0" class="java.lang.Long">
          <constructor>
            <property name="anLong">60</property><!-- time in seconds -->
          </constructor>
        </javabean>
      </parameter>
    </install>
    <uninstall method="removeApplicationEntity">
      <parameter>
        <inject bean="ProxyApplicationEntity1" />
      </parameter>
    </uninstall>
    <uninstall method="removeConnection">
      <parameter>
        <inject bean="ProxyConnection1" />
      </parameter>
    </uninstall>
    <start method="activate" />
    <stop method="deactivate" />
  </bean>

  <!-- Proxy Connection -->
  <bean name="ProxyConnection1" class="org.dcm4che.net.Connection">
    <property name="port">11112</property>
  </bean>

  <!-- Proxy DICOM Application Entity -->
  <bean name="ProxyApplicationEntity1" class="org.dcm4chee.proxy.mc.net.ProxyApplicationEntity">
    <constructor>
      <parameter>*</parameter>
    </constructor>
    <property name="associationAcceptor">true</property>
    <property name="associationInitiator">true</property>
    <property name="maxOpsPerformed">0</property>
    <property name="maxOpsInvoked">0</property>
    <property name="spoolDirectory">${jboss.server.data.dir}/proxy/</property>
    <property name="acceptDataOnFailedNegotiation">true</property>
    <property name="forwardDestination">
      <inject bean="ForwardApplicationEntity1" />
    </property>
    <property name="useCallingAETitle">
      <null/>
    </property>
    <property name="attributeCoercionURI">resource:dcm4chee-proxy-nullify-pn.xsl</property>
    <property name="forwardSchedule">
      <inject bean="forwardScheduleApplicationEntity1"/>
    </property>
    <property name="retries">
      <list>
        <javabean xmlns="urn:jboss:javabean:2.0" class="org.dcm4chee.proxy.mc.net.Retry">
          <constructor>
            <property name="AString">.conn</property><!-- retry type -->
            <property name="AInt">60</property><!-- time in seconds -->
            <property name="AInt">5</property><!-- number of retries -->
          </constructor>
        </javabean>
        <javabean xmlns="urn:jboss:javabean:2.0" class="org.dcm4chee.proxy.mc.net.Retry">
          <constructor>
            <property name="AString">.ass</property><!-- retry type -->
            <property name="AInt">60</property><!-- time in seconds -->
            <property name="AInt">5</property><!-- number of retries -->
          </constructor>
        </javabean>
      </list>
    </property>
    <install method="addConnection">
      <parameter>
        <inject bean="ProxyConnection1" />
      </parameter>
    </install>
    <uninstall method="removeConnection">
      <parameter>
        <inject bean="ProxyConnection1" />
      </parameter>
    </uninstall>
    <property name="exclusiveUseDefinedTC">true</property>
    <!-- add all TC -->
    <incallback method="addTransferCapability" />
    <!-- add defined TC 
    <install method="addTransferCapability" >
      <parameter>
        <inject bean="MRStorageSCP" />
      </parameter>
    </install>
    <install method="addTransferCapability" >
      <parameter>
        <inject bean="MRStorageSCU" />
      </parameter>
    </install>
    -->
    <property name="enableAuditLog">true</property>
    <property name="auditDirectory">${jboss.server.data.dir}/auditlog/</property>
  </bean>

  <!-- Forward Connection -->
  <bean name="ForwardConnection1" class="org.dcm4che.net.Connection">
    <property name="hostname">localhost</property>
    <property name="port">11113</property>
    <property name="requestTimeout">1000</property><!-- time in milliseconds -->
    <property name="dimseRSPTimeout">1000</property><!-- time in milliseconds -->
  </bean>

  <!-- Forward DICOM Application Entity -->
  <bean name="ForwardApplicationEntity1" class="org.dcm4che.net.ApplicationEntity">
    <constructor>
      <parameter>*</parameter>
    </constructor>
    <property name="associationAcceptor">true</property>
    <property name="maxOpsPerformed">0</property>
    <property name="maxOpsInvoked">0</property>
    <install method="addConnection">
      <parameter>
        <inject bean="ForwardConnection1" />
      </parameter>
    </install>
    <uninstall method="removeConnection">
      <parameter>
        <inject bean="ForwardConnection1" />
      </parameter>
    </uninstall>
  </bean>
  
  <!-- Schedule for Forward DICOM Application Entity -->
  <bean name="forwardScheduleApplicationEntity1" class="org.dcm4chee.proxy.mc.net.Schedule">
    <property name="days">Mon-Fri</property>
    <property name="hours">8-18</property>
  </bean>
  
  <!-- Schedule -->
  <bean name="Scheduler" class="org.dcm4chee.proxy.mc.net.Scheduler">
    <constructor>
      <parameter>
        <inject bean="Device"></inject>
      </parameter>
      <parameter>
        <inject bean="AuditLog"></inject>
      </parameter>
    </constructor>
    <start method="start" />
    <stop method="stop" />
  </bean>
  
  <!-- Audit Log -->
  <bean name="AuditLog" class="org.dcm4chee.proxy.mc.net.AuditLog">
    <property name="schedule">60</property>
  </bean>
  
</deployment>
